<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiser Clicker: Void Expansion</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f13;
            --bg-panel: rgba(30, 30, 35, 0.7);
            --primary: #8b5cf6; /* Violet */
            --primary-glow: rgba(139, 92, 246, 0.5);
            --secondary: #10b981; /* Emerald */
            --accent: #f43f5e; /* Rose */
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --radius: 16px;
        }

        body.true-ascension-mode {
            --bg-dark: #1a0505;
            --primary: #ef4444;
            --primary-glow: rgba(239, 68, 68, 0.5);
            --secondary: #f59e0b;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #2e1065 0%, var(--bg-dark) 60%);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            overflow: hidden; /* Custom scrolling within panels */
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 1.5s ease;
        }

        /* Canvas Background for Particles */
        #particle-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            border-bottom: var(--glass-border);
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        h1 { margin: 0; font-weight: 900; font-size: 1.5rem; letter-spacing: -0.5px; text-transform: uppercase; }
        .header-controls button {
            background: transparent;
            border: var(--glass-border);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
        }
        .header-controls button:hover { color: var(--text-main); border-color: var(--primary); background: rgba(255,255,255,0.05); }

        /* --- Main Layout --- */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 70px);
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .panel {
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            border: var(--glass-border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        /* --- Left Panel (Skills & Stats) --- */
        .stats-container { padding: 20px; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: var(--text-muted); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .stat-val { color: var(--text-main); font-weight: bold; }

        .skills-section { padding: 20px; border-top: var(--glass-border); flex: 1; overflow-y: auto; }
        .skill-card {
            background: rgba(255,255,255,0.03);
            border: var(--glass-border);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }
        .skill-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.05); }
        .skill-card.cooldown { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .skill-progress {
            position: absolute; bottom: 0; left: 0; height: 3px; background: var(--primary); width: 0%; transition: width 0.1s linear;
        }
        .skill-header { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 4px; }
        .skill-desc { font-size: 0.8rem; color: var(--text-muted); }

        /* --- Center Panel (Game Area) --- */
        .center-panel { align-items: center; justify-content: center; text-align: center; position: relative; }
        
        #score-display {
            font-size: 3.5rem; font-weight: 900; margin: 0;
            background: linear-gradient(to bottom, #fff, #ccc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .currency-label { font-size: 1rem; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }

        #click-btn {
            width: 220px; height: 220px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4c1d95, #2e1065);
            border: 4px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 50px var(--primary-glow), inset 0 0 20px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            z-index: 2;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem;
        }
        body.true-ascension-mode #click-btn { background: radial-gradient(circle at 30% 30%, #991b1b, #450a0a); border-color: #ef4444; }
        
        #click-btn:active { transform: scale(0.95); }
        #click-btn::after { content:'üñ±Ô∏è'; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }

        /* Floating Text Animation */
        .float-text {
            position: absolute; pointer-events: none;
            color: #fff; font-weight: bold; font-size: 1.2rem;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.2); opacity: 0; }
        }

        /* --- Right Panel (Upgrades) --- */
        .tabs { display: flex; padding: 10px; gap: 10px; border-bottom: var(--glass-border); }
        .tab-btn {
            flex: 1; background: rgba(0,0,0,0.2); border: none; color: var(--text-muted);
            padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s;
        }
        .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px var(--primary-glow); }

        .upgrades-list { flex: 1; overflow-y: auto; padding: 15px; }
        
        .upgrade-card {
            display: flex; align-items: center; gap: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 12px; border-radius: 12px; margin-bottom: 8px;
            transition: 0.2s;
        }
        .upgrade-card:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.2); }
        .upgrade-card.can-buy { border-left: 3px solid var(--primary); }
        .upgrade-icon { font-size: 1.5rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .upgrade-details { flex: 1; }
        .upgrade-name { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
        .upgrade-cost { font-size: 0.8rem; color: var(--primary); font-family: 'Roboto Mono'; }
        .upgrade-desc { font-size: 0.75rem; color: var(--text-muted); }
        .upgrade-count { background: rgba(0,0,0,0.4); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

        /* --- Modals & Special UI --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: #18181b; border: 1px solid var(--primary);
            padding: 30px; border-radius: 20px; width: 500px; max-width: 90%;
            text-align: center; position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* True Ascension Panel (Hidden by default) */
        #ta-trigger-panel {
            position: absolute; bottom: 20px; width: 90%;
            background: linear-gradient(45deg, #3f0e0e, #000);
            border: 2px solid #ef4444; padding: 15px; border-radius: 12px;
            display: none; animation: pulseRed 2s infinite;
        }
        @keyframes pulseRed { 0% {box-shadow:0 0 10px #f00;} 50% {box-shadow:0 0 25px #f00;} 100% {box-shadow:0 0 10px #f00;} }

        /* Artifacts (New Content) */
        .artifact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .artifact {
            border: 1px solid #f59e0b; background: rgba(245, 158, 11, 0.1);
            padding: 10px; border-radius: 8px; text-align: center; cursor: pointer;
        }
        .artifact:hover { background: rgba(245, 158, 11, 0.2); }
        .artifact h4 { margin: 0 0 5px 0; color: #f59e0b; font-size: 0.9rem; }
        .artifact p { margin: 0; font-size: 0.7rem; color: #ccc; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Responsive */
        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; height: auto; display: block; }
            .panel { margin-bottom: 20px; height: auto; max-height: 500px; }
            .center-panel { padding: 50px 0; }
        }
    </style>
</head>
<body>

<canvas id="particle-canvas"></canvas>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <h1>Paiser Clicker</h1>
        <span id="ta-badge" style="background:#ef4444; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold; display:none;">TRUE ASCENSION</span>
    </div>
    <div class="header-controls">
        <button onclick="ui.toggleModal('achievements-modal')">üèÜ Achievements</button>
        <button onclick="ui.toggleModal('settings-modal')">‚öôÔ∏è Data</button>
    </div>
</header>

<div class="main-grid">
    
    <!-- LEFT: Skills & Stats -->
    <div class="panel">
        <div style="padding:15px; background:rgba(0,0,0,0.2); font-weight:bold; border-bottom:var(--glass-border)">
            SYSTEM STATUS
        </div>
        <div class="stats-container">
            <div class="stat-row"><span>Output (PPC)</span> <span id="stat-ppc" class="stat-val">1.00</span></div>
            <div class="stat-row"><span>Auto (CPS)</span> <span id="stat-cps" class="stat-val">0.00</span></div>
            <div class="stat-row"><span>Evo Shards</span> <span id="stat-shards" class="stat-val" style="color:#f59e0b">0</span></div>
            <div class="stat-row"><span>Ascensions</span> <span id="stat-ascensions" class="stat-val">0</span></div>
        </div>

        <div class="skills-section">
            <h3 style="font-size:0.9rem; text-transform:uppercase; color:var(--text-muted); margin-top:0;">Active Skills</h3>
            <div id="skills-list"></div>
            
            <h3 style="font-size:0.9rem; text-transform:uppercase; color:var(--text-muted); margin-top:20px;">Artifacts (Perm)</h3>
            <div id="artifacts-list" class="artifact-grid">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- CENTER: Game -->
    <div class="panel center-panel">
        <div id="score-display">0</div>
        <div class="currency-label">Quantum Coins</div>

        <div id="click-btn"></div>

        <div id="message-box" style="margin-top:30px; height:20px; color:var(--text-muted); font-style:italic; font-size:0.9rem;">
            Initialize protocol...
        </div>

        <!-- Infinity Trigger -->
        <div id="ta-trigger-panel">
            <h3 style="color:#ef4444; margin:0;">‚ö†Ô∏è INFINITY REACHED ‚ö†Ô∏è</h3>
            <p style="font-size:0.8rem; margin:5px 0;">Reality is breaking. Perform True Ascension?</p>
            <button onclick="game.triggerTrueAscension()" style="background:#ef4444; color:white; border:none; padding:8px 20px; border-radius:5px; font-weight:bold; cursor:pointer; width:100%;">ASCEND (Reset All)</button>
        </div>
    </div>

    <!-- RIGHT: Upgrades -->
    <div class="panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="ui.switchTab('standard')">Basic</button>
            <button class="tab-btn" onclick="ui.switchTab('advanced')">Synergy</button>
            <button class="tab-btn" onclick="ui.switchTab('ascension')">Ascension</button>
        </div>
        <div id="upgrades-container" class="upgrades-list">
            <!-- Populated by JS -->
        </div>
        
        <div style="padding:15px; border-top:var(--glass-border); text-align:center;">
            <button id="ascend-btn" onclick="game.ascend()" disabled style="width:100%; padding:12px; background:var(--secondary); color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:not-allowed; opacity:0.5;">
                Ascend (Requires 10B)
            </button>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="achievements-modal" class="modal-overlay" onclick="if(event.target===this) ui.toggleModal('achievements-modal')">
    <div class="modal">
        <h2>Achievements</h2>
        <div id="achievements-list" style="max-height:300px; overflow-y:auto; text-align:left;"></div>
        <button onclick="ui.toggleModal('achievements-modal')" style="margin-top:15px; padding:8px 20px; background:transparent; border:1px solid #555; color:#fff; border-radius:5px; cursor:pointer;">Close</button>
    </div>
</div>

<div id="settings-modal" class="modal-overlay" onclick="if(event.target===this) ui.toggleModal('settings-modal')">
    <div class="modal">
        <h2>Data Management</h2>
        <p style="font-size:0.9rem; color:#aaa;">Your progress is saved automatically.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="game.exportSave()" style="padding:10px; background:#333; border:1px solid #555; color:#fff; border-radius:5px; cursor:pointer;">Export Save</button>
            <button onclick="game.importSave()" style="padding:10px; background:#333; border:1px solid #555; color:#fff; border-radius:5px; cursor:pointer;">Import Save</button>
            <button onclick="game.hardReset()" style="padding:10px; background:#ef4444; border:1px solid #500; color:#fff; border-radius:5px; cursor:pointer;">Hard Reset</button>
        </div>
        <textarea id="save-output" style="width:100%; height:60px; margin-top:15px; background:#000; color:#0f0; font-size:10px;" readonly></textarea>
    </div>
</div>

<div id="offline-modal" class="modal-overlay">
    <div class="modal">
        <h2 style="color:var(--secondary)">Welcome Back!</h2>
        <p>While you were in the void, your automated systems generated:</p>
        <h1 id="offline-gain" style="color:#fff;">0</h1>
        <p>Coins</p>
        <button onclick="document.getElementById('offline-modal').style.display='none'" style="padding:10px 30px; background:var(--primary); border:none; color:#fff; border-radius:8px; cursor:pointer; font-weight:bold;">Collect</button>
    </div>
</div>

<script>
/**
 * PAISER CLICKER - LOGIC ENGINE
 */

const CONSTANTS = {
    INFINITY: 1e300,
    ASCENSION_REQ: 1e10,
    SHARD_RATE: 0.1 // 10% bonus per shard
};

// --- Data Definitions ---
const UPGRADES = [
    // Basic (Tab: Standard)
    { id: 'cursor', name: 'Enhanced Cursor', cost: 15, baseVal: 1, type: 'ppc', tab: 'standard', icon: 'üëÜ' },
    { id: 'cpu', name: 'Quantum CPU', cost: 100, baseVal: 5, type: 'ppc', tab: 'standard', icon: 'üíæ' },
    { id: 'farm', name: 'Server Farm', cost: 500, baseVal: 5, type: 'cps', tab: 'standard', icon: 'üîã' },
    { id: 'mine', name: 'Data Mine', cost: 2000, baseVal: 20, type: 'cps', tab: 'standard', icon: '‚õèÔ∏è' },
    { id: 'factory', name: 'Robot Factory', cost: 10000, baseVal: 100, type: 'cps', tab: 'standard', icon: 'üè≠' },
    { id: 'bank', name: 'Offshore Bank', cost: 50000, baseVal: 400, type: 'cps', tab: 'standard', icon: 'üèõÔ∏è' },
    
    // Synergy / Advanced (Tab: Advanced) - Unlocks mid-game
    { id: 'syn_click', name: 'Click Synergy', cost: 1e6, baseVal: 0, type: 'synergy', tab: 'advanced', icon: '‚ö°', desc: 'Clicking adds 1% of CPS' },
    { id: 'flux', name: 'Flux Capacitor', cost: 5e6, baseVal: 2000, type: 'cps', tab: 'advanced', icon: 'üîÆ' },
    { id: 'dyson_s', name: 'Dyson Sphere', cost: 1e9, baseVal: 10000, type: 'cps', tab: 'advanced', icon: 'üåû' },
    { id: 'ai_god', name: 'AI Overlord', cost: 1e12, baseVal: 100000, type: 'cps', tab: 'advanced', icon: 'ü§ñ' },

    // Ascension (Tab: Ascension) - Only buys with Shards or Huge Coins
    { id: 'shard_boost', name: 'Shard Amplifier', cost: 1e15, baseVal: 0, type: 'multiplier', tab: 'ascension', icon: 'üíé', desc: 'Doubles Global Production' },
    { id: 'void_siphon', name: 'Void Siphon', cost: 1e20, baseVal: 1e6, type: 'cps', tab: 'ascension', icon: '‚ö´' }
];

const SKILLS = [
    { id: 'overclock', name: 'Overclock', duration: 10, cooldown: 60, effect: 'cps_2x', desc: 'Double CPS for 10s' },
    { id: 'midas', name: 'Midas Touch', duration: 0, cooldown: 120, effect: 'click_100x', desc: 'Next click worth 100x' },
    { id: 'time_warp', name: 'Time Warp', duration: 0, cooldown: 300, effect: 'warp_30m', desc: 'Skip 30 mins instantly' }
];

const ARTIFACTS = [
    { id: 'crit_chip', name: 'Crit Chip', cost: 5, desc: '10% chance for 5x Click', owned: false },
    { id: 'comp_int', name: 'Compound Interest', cost: 10, desc: '+1% Coins per second (Cap)', owned: false },
    { id: 'auto_click', name: 'Nano-Bots', cost: 20, desc: 'Auto-Click 5 times/sec', owned: false }
];

// --- Game State ---
let state = {
    score: 0,
    totalScore: 0,
    startTime: Date.now(),
    lastSave: Date.now(),
    evoShards: 0,
    ascensions: 0,
    trueAscensions: 0,
    upgrades: {}, // { id: count }
    artifacts: [],
    skills: {}, // { id: lastUsedTime }
    achievements: []
};

// Initialize Upgrade Counts
UPGRADES.forEach(u => state.upgrades[u.id] = 0);

// --- Core System ---
const game = {
    ppc: 1,
    cps: 0,
    globalMult: 1,
    loopId: null,
    activeSkillMult: 1,

    init() {
        this.load();
        this.startLoop();
        ui.init();
        this.checkOfflineProgress();
    },

    calculateStats() {
        let ppc = 1;
        let cps = 0;
        
        // 1. Base Calc
        UPGRADES.forEach(u => {
            const count = state.upgrades[u.id];
            if (count > 0) {
                if (u.type === 'ppc') ppc += u.baseVal * count;
                if (u.type === 'cps') cps += u.baseVal * count;
                if (u.type === 'multiplier') this.globalMult *= Math.pow(2, count);
            }
        });

        // 2. Synergy
        if (state.upgrades['syn_click'] > 0) {
            ppc += (cps * 0.01 * state.upgrades['syn_click']);
        }

        // 3. Artifacts
        if (state.artifacts.includes('auto_click')) {
            // Handled in loop
        }

        // 4. Evo Shard Bonus
        let shardBonus = 1 + (state.evoShards * CONSTANTS.SHARD_RATE);
        
        // 5. True Ascension Scaling
        if (state.trueAscensions > 0) {
            shardBonus = 1 + (state.evoShards * 0.05); // Nerfed in TA
            this.globalMult *= (state.trueAscensions * 2); // TA Bonus
        }

        this.ppc = ppc * shardBonus * this.globalMult;
        this.cps = cps * shardBonus * this.globalMult;
    },

    click() {
        let gain = this.ppc;
        
        // Critical Hit Artifact
        let isCrit = false;
        if (state.artifacts.includes('crit_chip') && Math.random() < 0.1) {
            gain *= 5;
            isCrit = true;
        }

        // Midas Skill
        if (state.skills['midas'] === 'active') {
            gain *= 100;
            state.skills['midas'] = Date.now(); // Start cooldown
            ui.renderSkills(); // Update visual state
        }

        this.addScore(gain);
        ui.spawnFloater(gain, isCrit);
        
        // Particle Effect
        const btn = document.getElementById('click-btn');
        const rect = btn.getBoundingClientRect();
        const x = rect.left + rect.width/2;
        const y = rect.top + rect.height/2;
        particles.explode(x, y, isCrit ? '#f59e0b' : null);
    },

    addScore(amount) {
        if (state.score + amount >= CONSTANTS.INFINITY && state.trueAscensions === 0) {
            state.score = CONSTANTS.INFINITY;
            ui.showTATrigger();
        } else {
            state.score += amount;
            state.totalScore += amount;
        }
        this.checkAchievements();
    },

    buyUpgrade(id) {
        const u = UPGRADES.find(x => x.id === id);
        const cost = this.getCost(u);
        if (state.score >= cost) {
            state.score -= cost;
            state.upgrades[id]++;
            this.calculateStats();
            ui.update();
        }
    },

    buyArtifact(id) {
        const art = ARTIFACTS.find(a => a.id === id);
        if (state.evoShards >= art.cost && !state.artifacts.includes(id)) {
            state.evoShards -= art.cost;
            state.artifacts.push(id);
            this.calculateStats();
            ui.renderSkills(); // Refresh artifacts list
        }
    },

    activateSkill(id) {
        const skill = SKILLS.find(s => s.id === id);
        const lastUsed = state.skills[id] || 0;
        const now = Date.now();

        if (now - lastUsed >= skill.cooldown * 1000) {
            // Activate
            if (skill.effect === 'cps_2x') {
                this.activeSkillMult = 2;
                state.skills[id] = now; // Set activation time
                setTimeout(() => { this.activeSkillMult = 1; }, skill.duration * 1000);
            } else if (skill.effect === 'click_100x') {
                state.skills[id] = 'active'; // Special flag
            } else if (skill.effect === 'warp_30m') {
                state.skills[id] = now;
                this.addScore(this.cps * 1800);
                ui.spawnFloater(this.cps * 1800, true);
            }
            ui.renderSkills();
        }
    },

    getCost(u) {
        let multiplier = 1.15;
        // True Ascension makes game harder
        if (state.trueAscensions > 0) multiplier = 1.5;
        
        return Math.floor(u.cost * Math.pow(multiplier, state.upgrades[u.id]));
    },

    loop() {
        const now = Date.now();
        const dt = (now - state.lastSave) / 1000; // Delta in seconds
        
        if (dt >= 0.1) { // Update every 100ms logic-wise for smoother rendering
            let production = (this.cps * this.activeSkillMult) * dt;
            
            // Nano-bots artifact
            if (state.artifacts.includes('auto_click')) {
                production += (this.ppc * 5) * dt;
            }

            if (production > 0) this.addScore(production);
            
            state.lastSave = now;
            ui.update();
        }

        // Auto-save every 5s
        if (now % 5000 < 50) this.save();
        
        requestAnimationFrame(() => this.loop());
    },

    startLoop() {
        this.loop();
    },

    ascend() {
        if (state.score < CONSTANTS.ASCENSION_REQ) return;
        const shardsEarned = Math.floor(Math.sqrt(state.score / CONSTANTS.ASCENSION_REQ));
        
        state.evoShards += shardsEarned;
        state.ascensions++;
        this.softReset();
    },

    triggerTrueAscension() {
        if (confirm("Are you sure? This resets EVERYTHING for a permanent difficulty multiplier and bragging rights.")) {
            state.trueAscensions++;
            this.hardReset(true); // Keep TA stat
            document.body.classList.add('true-ascension-mode');
            document.getElementById('ta-badge').style.display = 'inline-block';
            document.getElementById('ta-trigger-panel').style.display = 'none';
        }
    },

    softReset() {
        state.score = 0;
        state.upgrades = {};
        UPGRADES.forEach(u => state.upgrades[u.id] = 0);
        // Skills reset
        state.skills = {};
        this.calculateStats();
        ui.renderUpgrades();
        this.save();
    },

    hardReset(keepTA = false) {
        const ta = keepTA ? state.trueAscensions : 0;
        state = {
            score: 0, totalScore: 0, startTime: Date.now(), lastSave: Date.now(),
            evoShards: 0, ascensions: 0, trueAscensions: ta,
            upgrades: {}, artifacts: [], skills: {}, achievements: []
        };
        UPGRADES.forEach(u => state.upgrades[u.id] = 0);
        this.calculateStats();
        ui.init();
        this.save();
        if(!keepTA) location.reload();
    },

    checkAchievements() {
        const list = [
            {id: '1k', req: 1000, name: 'Kilo-Byte'},
            {id: '1m', req: 1e6, name: 'Mega-Byte'},
            {id: '1b', req: 1e9, name: 'Giga-Byte'},
            {id: 'asc', req: () => state.ascensions > 0, name: 'Reborn'}
        ];
        
        list.forEach(a => {
            if (!state.achievements.includes(a.id)) {
                let pass = typeof a.req === 'function' ? a.req() : state.totalScore >= a.req;
                if (pass) {
                    state.achievements.push(a.id);
                    ui.spawnFloater(`üèÜ ${a.name}`, true);
                }
            }
        });
    },

    checkOfflineProgress() {
        const now = Date.now();
        if (state.lastSave && now - state.lastSave > 60000) { // 1 minute
            const seconds = (now - state.lastSave) / 1000;
            this.calculateStats();
            const earned = this.cps * seconds;
            if (earned > 10) {
                state.score += earned;
                document.getElementById('offline-gain').innerText = ui.format(earned);
                document.getElementById('offline-modal').style.display = 'flex';
            }
        }
    },

    save() {
        localStorage.setItem('paiserSave', JSON.stringify(state));
    },

    load() {
        const d = localStorage.getItem('paiserSave');
        if (d) {
            const s = JSON.parse(d);
            // Merge save to ensure new fields exist
            state = { ...state, ...s };
            // Ensure upgrades object has all keys
            UPGRADES.forEach(u => { if(state.upgrades[u.id] === undefined) state.upgrades[u.id] = 0; });
            
            if (state.trueAscensions > 0) {
                document.body.classList.add('true-ascension-mode');
                document.getElementById('ta-badge').style.display = 'inline-block';
            }
        }
        this.calculateStats();
    },
    
    exportSave() {
        document.getElementById('save-output').value = btoa(JSON.stringify(state));
    },
    
    importSave() {
        const str = prompt("Paste save code:");
        if (str) {
            try {
                localStorage.setItem('paiserSave', atob(str));
                location.reload();
            } catch(e) { alert("Invalid save"); }
        }
    }
};

// --- UI Controller ---
const ui = {
    currentTab: 'standard',
    
    init() {
        this.renderUpgrades();
        this.renderSkills();
        document.getElementById('click-btn').addEventListener('mousedown', () => game.click());
        
        // Tab listeners
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
                e.target.classList.add('active');
            });
        });
    },

    switchTab(tab) {
        this.currentTab = tab;
        this.renderUpgrades();
    },

    format(n) {
        if (n >= CONSTANTS.INFINITY) return "‚àû";
        if (n < 1000) return Math.floor(n).toLocaleString();
        const s = ['', 'k', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp'];
        const e = Math.floor(Math.log10(n) / 3);
        if (e >= s.length) return n.toExponential(2);
        return (n / Math.pow(1000, e)).toFixed(2) + s[e];
    },

    update() {
        document.getElementById('score-display').innerText = this.format(state.score);
        document.getElementById('stat-ppc').innerText = this.format(game.ppc);
        document.getElementById('stat-cps').innerText = this.format(game.cps);
        document.getElementById('stat-shards').innerText = state.evoShards;
        document.getElementById('stat-ascensions').innerText = state.ascensions;

        // Update Upgrades
        UPGRADES.filter(u => u.tab === this.currentTab).forEach(u => {
            const card = document.getElementById(`upg-${u.id}`);
            if (card) {
                const cost = game.getCost(u);
                card.querySelector('.upgrade-cost').innerText = this.format(cost);
                card.querySelector('.upgrade-count').innerText = state.upgrades[u.id];
                if (state.score >= cost) card.classList.add('can-buy');
                else card.classList.remove('can-buy');
            }
        });

        // Update Skills Cooldowns
        SKILLS.forEach(s => {
            const last = state.skills[s.id];
            const card = document.getElementById(`skill-${s.id}`);
            if (!card) return;
            
            if (last === 'active') {
                card.classList.add('active-glow'); // Visual flair needed
            } else {
                const diff = (Date.now() - (last || 0)) / 1000;
                const remaining = s.cooldown - diff;
                const bar = card.querySelector('.skill-progress');
                
                if (remaining > 0) {
                    card.classList.add('cooldown');
                    const pct = (remaining / s.cooldown) * 100;
                    bar.style.width = pct + '%';
                } else {
                    card.classList.remove('cooldown');
                    bar.style.width = '0%';
                }
            }
        });
        
        // Ascend Button
        const abtn = document.getElementById('ascend-btn');
        if (state.score >= CONSTANTS.ASCENSION_REQ) {
            abtn.disabled = false;
            abtn.style.opacity = 1;
            const shards = Math.floor(Math.sqrt(state.score / CONSTANTS.ASCENSION_REQ));
            abtn.innerText = `ASCEND (+${shards} Shards)`;
        } else {
            abtn.disabled = true;
            abtn.style.opacity = 0.5;
            abtn.innerText = "Ascend (Requires 10B)";
        }
    },

    renderUpgrades() {
        const container = document.getElementById('upgrades-container');
        container.innerHTML = '';
        
        UPGRADES.filter(u => u.tab === this.currentTab).forEach(u => {
            const div = document.createElement('div');
            div.className = 'upgrade-card';
            div.id = `upg-${u.id}`;
            div.onclick = () => game.buyUpgrade(u.id);
            div.innerHTML = `
                <div class="upgrade-icon">${u.icon}</div>
                <div class="upgrade-details">
                    <div style="display:flex; justify-content:space-between;">
                        <span class="upgrade-name">${u.name}</span>
                        <span class="upgrade-count">${state.upgrades[u.id]}</span>
                    </div>
                    <div class="upgrade-desc">${u.desc || (u.type==='ppc' ? `+${u.baseVal} PPC` : `+${u.baseVal} CPS`)}</div>
                    <div class="upgrade-cost">${this.format(game.getCost(u))}</div>
                </div>
            `;
            container.appendChild(div);
        });
    },

    renderSkills() {
        const sList = document.getElementById('skills-list');
        sList.innerHTML = '';
        SKILLS.forEach(s => {
            const div = document.createElement('div');
            div.className = 'skill-card';
            div.id = `skill-${s.id}`;
            div.onclick = () => game.activateSkill(s.id);
            div.innerHTML = `
                <div class="skill-header">
                    <span>${s.name}</span>
                    <span style="font-size:0.7rem; opacity:0.7">${s.cooldown}s</span>
                </div>
                <div class="skill-desc">${s.desc}</div>
                <div class="skill-progress"></div>
            `;
            sList.appendChild(div);
        });

        const aList = document.getElementById('artifacts-list');
        aList.innerHTML = '';
        ARTIFACTS.forEach(a => {
            const owned = state.artifacts.includes(a.id);
            const div = document.createElement('div');
            div.className = 'artifact';
            if (owned) div.style.borderColor = '#10b981';
            div.onclick = () => game.buyArtifact(a.id);
            div.innerHTML = `
                <h4>${a.name} ${owned ? '‚úÖ' : ''}</h4>
                <p>${a.desc}</p>
                ${!owned ? `<div style="margin-top:5px; font-weight:bold; color:#fff">${a.cost} Shards</div>` : ''}
            `;
            aList.appendChild(div);
        });
    },

    spawnFloater(text, isCrit) {
        const btn = document.getElementById('click-btn');
        const rect = btn.getBoundingClientRect();
        
        // Randomize position slightly
        const x = rect.left + rect.width/2 + (Math.random()*60 - 30);
        const y = rect.top + rect.height/2;

        const el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = typeof text === 'number' ? `+${this.format(text)}` : text;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        
        if(isCrit) {
            el.style.color = '#f59e0b';
            el.style.fontSize = '1.5rem';
            el.style.textShadow = '0 0 10px #f59e0b';
        }

        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    },
    
    showTATrigger() {
        document.getElementById('ta-trigger-panel').style.display = 'block';
    },

    toggleModal(id) {
        const m = document.getElementById(id);
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        if (id === 'achievements-modal') this.renderAchievements();
    },

    renderAchievements() {
        const list = document.getElementById('achievements-list');
        list.innerHTML = state.achievements.map(id => `<div style="padding:5px; border-bottom:1px solid #333">üèÜ ${id}</div>`).join('');
    }
};

// --- Particles System ---
const particles = {
    canvas: document.getElementById('particle-canvas'),
    ctx: document.getElementById('particle-canvas').getContext('2d'),
    items: [],
    
    init() {
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.animate();
    },
    
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },
    
    explode(x, y, color) {
        for(let i=0; i<15; i++) {
            this.items.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10,
                life: 1,
                color: color || `hsl(${Math.random()*360}, 70%, 50%)`
            });
        }
    },
    
    animate() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.items.forEach((p, index) => {
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.02;
            p.vy += 0.2; // Gravity
            
            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
            this.ctx.fill();
            
            if(p.life <= 0) this.items.splice(index, 1);
        });
        
        requestAnimationFrame(() => this.animate());
    }
};

// Start
particles.init();
game.init();

</script>
</body>
</html>
